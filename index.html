<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Get Your Membership Card</title>

<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Fonts -->
<link href="https://api.fontshare.com/v2/css?f[]=clash-grotesk@200,300,400,500,600,700&display=swap" rel="stylesheet">

<!-- Cropper.js -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

<style>
body { font-family: 'Clash Grotesk', sans-serif; background-color: #0f0f0f; color: #ffffff; }
.glass-panel { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
.input-dark { background-color: #1a1a1a; border: 1px solid #333; color: white; transition: all 0.3s ease; }
.input-dark:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2); }

/* Cropper Customization */
.cropper-view-box, .cropper-face { border-radius: 0; outline-color: #3b82f6; }
.cropper-modal { background-color: #000; opacity: 0.8; }

.loader { border: 3px solid #333; border-top: 3px solid #3b82f6; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4">

<!-- Navbar -->
<nav class="absolute top-0 w-full p-6 border-b border-gray-800 flex justify-between bg-[#0f0f0f]/80 backdrop-blur z-40">
<div class="text-xl font-bold tracking-wider text-white">CARD<span class="text-blue-500">GEN</span></div>
</nav>

<!-- STEP 1: FORM -->
<div id="view-form" class="w-full max-w-lg z-10">
<div class="glass-panel p-8 rounded-2xl space-y-6">
<div class="text-center space-y-2">
<h1 class="text-3xl font-bold">Create Your Sanad Status</h1>
<p class="text-gray-400 text-sm">Enter your details and upload a photo (Max 20MB).</p>
<div id="system-status" class="text-xs text-yellow-500 font-mono">Connecting to system...</div>
</div>

<form onsubmit="window.app.generateCard(event)" id="card-form" class="space-y-5 opacity-50 pointer-events-none transition-opacity">

<!-- Name Input -->
<div>
<label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">Full Name</label>
<input type="text" id="user-name" required placeholder="Ex: John Doe" class="w-full p-4 rounded-xl input-dark text-lg">
</div>

<!-- Photo Upload & Preview -->
<div>
<label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">Profile Photo</label>

<!-- Hidden File Input -->
<input type="file" id="photo-input" accept="image/*" class="hidden" onchange="window.app.handleFileSelect(this)">

<!-- Custom Upload Area -->
<div id="upload-area" onclick="document.getElementById('photo-input').click()" class="border-2 border-dashed border-gray-700 rounded-xl p-6 flex flex-col items-center justify-center cursor-pointer hover:border-blue-500 hover:bg-gray-800/50 transition group min-h-[160px]">

<!-- Preview Container (Hidden initially) -->
<div id="preview-container" class="hidden w-32 h-32 rounded-lg overflow-hidden border-2 border-blue-500 shadow-lg mb-2 relative">
<img id="cropped-preview" class="w-full h-full object-cover">
</div>

<!-- Placeholder (Visible initially) -->
<div id="upload-placeholder" class="text-center">
<div class="w-12 h-12 bg-gray-800 rounded-full flex items-center justify-center mx-auto mb-3 group-hover:bg-blue-900/30 transition">
<svg class="w-6 h-6 text-gray-400 group-hover:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
</div>
<p class="text-sm text-gray-300 font-medium">Click to upload photo</p>
<p class="text-xs text-gray-500 mt-1">Files up to 15MB supported</p>
</div>
</div>
<p id="photo-error" class="text-red-500 text-xs mt-2 hidden">Please upload and crop a photo.</p>
</div>

<!-- Submit Button -->
<button type="submit" id="generate-btn" class="w-full py-4 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl transition shadow-lg shadow-blue-900/20 flex justify-center items-center gap-2">
Generate
</button>
</form>
</div>
</div>

<!-- CROPPER MODAL (Popup Style) -->
<div id="cropper-modal" class="fixed inset-0 z-50 hidden bg-black/80 backdrop-blur-sm flex items-center justify-center p-4">
<div class="bg-[#1a1a1a] w-full max-w-lg rounded-2xl border border-gray-800 shadow-2xl overflow-hidden flex flex-col max-h-[90vh] animate-in fade-in zoom-in duration-300">

<!-- Header -->
<div class="p-4 border-b border-gray-800 flex justify-between items-center bg-[#0f0f0f]">
<div>
<h3 class="font-bold text-white text-lg">Adjust Photo</h3>
<p class="text-xs text-gray-400">Crop your image to fit the square frame.</p>
</div>
<button onclick="app.cancelCrop()" class="p-2 hover:bg-gray-800 rounded-full transition text-gray-400 hover:text-white">
<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
</button>
</div>

<!-- Cropper Container -->
<div class="relative flex-grow bg-black h-80 sm:h-96 w-full">
<img id="cropper-image" class="block max-w-full max-h-full mx-auto">
</div>

<!-- Footer -->
<div class="p-4 border-t border-gray-800 bg-[#0f0f0f] flex justify-end gap-3">
<button onclick="app.cancelCrop()" class="px-6 py-2 rounded-xl text-gray-400 font-medium hover:text-white hover:bg-gray-800 transition">Cancel</button>
<button onclick="app.confirmCrop()" class="px-8 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-xl font-bold shadow-lg shadow-blue-600/20 transition flex items-center gap-2">
<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
Submit
</button>
</div>
</div>
</div>

<!-- STEP 2: RESULT VIEW (Hidden) -->
<div id="view-result" class="hidden w-full max-w-4xl z-10 flex-col items-center">
<div class="glass-panel p-4 md:p-8 rounded-2xl flex flex-col items-center space-y-6 w-full">
<h2 class="text-2xl font-bold text-white">Your Card is Ready!</h2>

<div class="relative w-full flex justify-center overflow-auto rounded-lg shadow-2xl border border-gray-800">
<canvas id="card-canvas" class="max-w-full h-auto"></canvas>
</div>

<div class="w-full text-center" id="save-status"></div>

<div class="flex flex-col sm:flex-row gap-4 w-full max-w-md">
<button onclick="app.downloadCard()" class="flex-1 py-3 bg-white text-black font-bold rounded-lg hover:bg-gray-200 transition flex items-center justify-center gap-2">
<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
Download Card
</button>
<button onclick="location.reload()" class="flex-1 py-3 border border-gray-600 text-gray-300 font-medium rounded-lg hover:bg-gray-800 transition">
Create New
</button>
</div>
</div>
</div>

<!-- Firebase SDKs -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
// IMPORT onSnapshot for Real-time Updates
import { getFirestore, collection, addDoc, serverTimestamp, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";

// Configuration (Shared Project MVS)
const firebaseConfig = {
apiKey: "AIzaSyDEJUuNeIej1KKJ2gJKHop4ezWxv3B4CC4",
authDomain: "mvs-db-99118.firebaseapp.com",
projectId: "mvs-db-99118",
storageBucket: "mvs-db-99118.firebasestorage.app",
messagingSenderId: "525394480070",
appId: "1:525394480070:web:976de2685230832b2940c7",
measurementId: "G-EZ8WTRXK93"
};

const appInstance = initializeApp(firebaseConfig);
const db = getFirestore(appInstance);
const auth = getAuth(appInstance);

// Ensure user is authenticated anonymously to read/write DB
const ensureAuth = async () => {
if (auth.currentUser) return;
try {
await signInAnonymously(auth);
} catch (e) {
console.error("Auth Error:", e);
if (e.code === 'auth/admin-restricted-operation' || e.message.includes('admin-restricted-operation')) {
alert("System Error: Anonymous Authentication is disabled. Enable it in Firebase Console > Authentication > Sign-in method.");
}
}
};

// NEW: Real-time Listener function
window.subscribeToSettings = (onUpdate) => {
ensureAuth().then(() => {
// DISTINCT CONFIG for Sanad
onSnapshot(doc(db, "app_settings", "sanad_config"), (docSnap) => {
if (docSnap.exists()) {
onUpdate({ success: true, data: docSnap.data() });
} else {
onUpdate({ success: false, error: "System maintenance." });
}
}, (error) => {
onUpdate({ success: false, error: error.message });
});
});
};

window.saveCardToDB = async (data) => {
await ensureAuth();
try {
// DISTINCT COLLECTION: sanad
await addDoc(collection(db, "sanad"), {
...data,
timestamp: serverTimestamp()
});
return { success: true };
} catch (e) {
console.error("DB Error: ", e);
return { success: false, error: e.message };
}
};
</script>

<!-- Main Logic -->
<script>
window.app = {
config: null,
templateUrl: null,
cropper: null,
croppedBlob: null,
// UPDATED CLOUDINARY CONFIG
cloudinary: {
cloudName: 'da6fjyirm',
uploadPreset: 'ifada-card' // Changed from ifadamem to ifada-card
},

async init() {
// Use the new Subscription method instead of fetch-once
if (window.subscribeToSettings) {
window.subscribeToSettings((result) => {
const statusEl = document.getElementById('system-status');

if (result.success) {
// Automatically update local state
this.config = result.data.config;
this.templateUrl = result.data.templateUrl;

// Visual Feedback for User
statusEl.innerHTML = "System Synced & Ready <span class='text-green-400'>●</span>";
statusEl.className = "text-xs text-green-500 font-mono font-bold transition-all duration-500";

// Unlock form
document.getElementById('card-form').classList.remove('opacity-50', 'pointer-events-none');
} else {
statusEl.innerText = result.error;
statusEl.className = "text-xs text-red-500 font-mono";
}
});
} else {
setTimeout(() => this.init(), 500);
}
},

// --- CROPPER LOGIC ---
handleFileSelect(input) {
if (input.files && input.files[0]) {
const file = input.files[0];

if (file.size > 20 * 1024 * 1024) {
alert("File is too large. Please use an image under 20MB.");
input.value = '';
return;
}

const objectUrl = URL.createObjectURL(file);
const image = document.getElementById('cropper-image');
image.src = objectUrl;

document.getElementById('cropper-modal').classList.remove('hidden');

if (this.cropper) {
this.cropper.destroy();
}

this.cropper = new Cropper(image, {
aspectRatio: 1, // Force Square
viewMode: 1,
dragMode: 'move',
autoCropArea: 1,
background: false,
ready() {}
});
}
},

cancelCrop() {
document.getElementById('cropper-modal').classList.add('hidden');
document.getElementById('photo-input').value = ''; // Reset input
if (this.cropper) {
this.cropper.destroy();
this.cropper = null;
}
},

confirmCrop() {
if (!this.cropper) return;

const canvas = this.cropper.getCroppedCanvas({
width: 1080,
height: 1080,
imageSmoothingQuality: 'high'
});

const previewImg = document.getElementById('cropped-preview');
previewImg.src = canvas.toDataURL();

document.getElementById('preview-container').classList.remove('hidden');
document.getElementById('upload-placeholder').classList.add('hidden');
document.getElementById('photo-error').classList.add('hidden');

canvas.toBlob((blob) => {
this.croppedBlob = blob;
}, 'image/jpeg', 0.9);

document.getElementById('cropper-modal').classList.add('hidden');
this.cropper.destroy();
this.cropper = null;
},

// --- GENERATION LOGIC ---
async generateCard(e) {
e.preventDefault();

const name = document.getElementById('user-name').value;
if (!this.croppedBlob) {
document.getElementById('photo-error').classList.remove('hidden');
return;
}

if (!this.templateUrl) {
alert("Admin has not set a template yet.");
return;
}

const btn = document.getElementById('generate-btn');
const originalText = btn.innerHTML;
btn.disabled = true;
btn.innerHTML = '<span class="loader"></span> Generating...';

try {
// 1. DRAW CARD LOCALLY FIRST
const finalCardBlob = await this.drawFinalCard(name, this.croppedBlob);

// 2. SHOW RESULT IMMEDIATELY
document.getElementById('view-form').classList.add('hidden');
document.getElementById('view-result').classList.remove('hidden');
document.getElementById('view-result').classList.add('flex');
document.getElementById('save-status').innerHTML = '<span class="text-yellow-500 text-sm animate-pulse">Syncing with database...</span>';

// 3. START BACKGROUND UPLOADS
this.performBackgroundUploads(name, this.croppedBlob, finalCardBlob);

} catch (err) {
console.error(err);
alert("Error generating card: " + err.message);
} finally {
btn.disabled = false;
btn.innerHTML = originalText;
}
},

async performBackgroundUploads(name, userPhotoBlob, finalCardBlob) {
const statusDiv = document.getElementById('save-status');
try {
// Upload User Photo
const userPhotoUrl = await this.uploadToCloudinary(userPhotoBlob);
// Upload Final Card
const finalCardUrl = await this.uploadToCloudinary(finalCardBlob);

// Save to DB (Collection: sanad)
if (window.saveCardToDB) {
await window.saveCardToDB({
name: name,
userPhotoUrl: userPhotoUrl,
imageUrl: finalCardUrl
});
statusDiv.innerHTML = '<span class="text-green-500 text-sm font-bold">✓ Saved to system records</span>';
}
} catch (error) {
console.warn("Background upload failed:", error);
statusDiv.innerHTML = '<span class="text-orange-500 text-sm">⚠ Card generated locally (Offline/Network Error)</span>';
}
},

drawFinalCard(name, userPhotoBlob) {
return new Promise((resolve, reject) => {
const canvas = document.getElementById('card-canvas');
const ctx = canvas.getContext('2d');

const templateImg = new Image();
templateImg.crossOrigin = "Anonymous";
templateImg.src = this.templateUrl;

templateImg.onload = () => {
canvas.width = templateImg.width;
canvas.height = templateImg.height;

const userImg = new Image();
userImg.src = URL.createObjectURL(userPhotoBlob);

userImg.onload = async () => {
const photoConf = this.config.userPhoto || { x: 50, y: 50, width: 300, height: 300 };
const nameConf = this.config.name || { x: 50, y: 80, size: 40, color: '#FFFFFF' };

// 1. DRAW USER PHOTO (Behind)
const px = (photoConf.x / 100) * canvas.width;
const py = (photoConf.y / 100) * canvas.height;
const pw = photoConf.width;
const ph = photoConf.height;

ctx.drawImage(userImg, px - (pw/2), py - (ph/2), pw, ph);

// 2. DRAW TEMPLATE (Overlay)
ctx.drawImage(templateImg, 0, 0);

// 3. DRAW NAME
const nx = (nameConf.x / 100) * canvas.width;
const ny = (nameConf.y / 100) * canvas.height;
const scaleFactor = canvas.width / 1000;
const nSize = nameConf.size * (scaleFactor < 1 ? 1 : scaleFactor) * 1.5;

const fontSpec = `600 ${nSize}px 'Clash Grotesk'`;
try {
await document.fonts.load(fontSpec);
} catch (e) {
console.warn("Font loading timed out, using fallback", e);
}

ctx.font = fontSpec;
ctx.fillStyle = nameConf.color || '#FFFFFF';
ctx.textAlign = 'left';
ctx.fillText(name, nx, ny);

canvas.toBlob((blob) => {
resolve(blob);
}, 'image/png');
};
};
templateImg.onerror = () => reject(new Error("Failed to load template image. Check Admin Panel."));
});
},

async uploadToCloudinary(fileOrBlob) {
const formData = new FormData();
formData.append('file', fileOrBlob);
formData.append('upload_preset', this.cloudinary.uploadPreset.trim());

const res = await fetch(`https://api.cloudinary.com/v1_1/${this.cloudinary.cloudName.trim()}/image/upload`, {
method: 'POST',
body: formData
});

if (!res.ok) throw new Error(`Upload failed: ${res.statusText}`);
const data = await res.json();
return data.secure_url;
},

downloadCard() {
const canvas = document.getElementById('card-canvas');
const link = document.createElement('a');
link.download = 'My_Membership_Card.png';
link.href = canvas.toDataURL('image/png');
link.click();
}
};

window.onload = () => window.app.init();
</script>
</body>
</html>
